<!DOCTYPE html>


  
<html itemscope itemtype="https://schema.org/WebPage" class="no-js" lang="en">

<head prefix="og: http://ogp.me/ns#">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="siteBaseUrl" content="https://blog.ronan.us.kg/">
    <meta name="author" content="Ronan">
    <meta name="description" content="Bilberry Premium Theme for Hugo.">
    <meta name="keywords" content="blog,personal,responsive,search,font awesome,pages,posts,multilingual,syntax highlighting,premium,shortcuts">
    <meta name="generator" content="Hugo 0.136.2">
    <title>
        
           
               「platformIO」基于 stm32 HAL库 的工程模板 &vert; Ronan Blog
           
        
    </title>
    <meta itemprop="name" content="「platformIO」基于 stm32 HAL库 的工程模板">
    <meta itemprop="description" content="「platformIO」基于 stm32 HAL库 的工程模板 - Bilberry Premium Theme for Hugo.">
    <meta property="og:site_name" content="Ronan Blog">

    <meta property="og:url" content="https://blog.ronan.us.kg/posts/platformio%E5%9F%BA%E4%BA%8E-stm32-hal%E5%BA%93-%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF/">
  <meta property="og:site_name" content="Ronan Blog">
  <meta property="og:title" content="「platformIO」基于 stm32 HAL库 的工程模板">
  <meta property="og:description" content="1.建立 Makefile 工程 通过 STM32CubeMX 建立适于自己开发版的 Makefile 工程（步骤不赘述，百度一下，你就知道），并且记住「工程名」和「工程存放路径」。
2.新建 platformIO 工程 新建 platformIO 工程时的「Framework」一定要选择「STM32Cube」，新建工程的「工程名」和「工程存放路径」要与之前建立的 Makefile 工程一致。
工程建立完成后，你应该会得到如下项目结构：
├── Core │ ├── Inc │ │ ├── gpio.h │ │ ├── main.h │ │ ├── ... │ └── Src │ ├── gpio.c │ ├── main.c │ ├── ... ├── Drivers │ ├── CMSIS │ │ ├── Device │ │ │ └── ST │ │ │ └── STM32F1xx │ │ │ ├── Include │ │ │ │ ├── stm32f103xb.h │ │ │ │ ├── stm32f1xx.h │ │ │ │ └── system_stm32f1xx.h │ │ │ ├── LICENSE.txt │ │ │ └── Source │ │ │ └── Templates │ │ ├── Include │ │ │ ├── cmsis_armcc.h │ │ │ ├── cmsis_armclang.h │ │ │ ├── cmsis_compiler.h │ │ │ ├── cmsis_gcc.h │ │ │ ├── ... │ │ └── LICENSE.txt │ └── STM32F1xx_HAL_Driver │ ├── Inc │ │ ├── Legacy │ │ │ └── stm32_hal_legacy.h │ │ ├── stm32f1xx_hal.h │ │ ├── stm32f1xx_hal_cortex.h │ │ ├── stm32f1xx_hal_def.h │ │ ├── ... │ ├── LICENSE.txt │ └── Src │ ├── stm32f1xx_hal.c │ ├── stm32f1xx_hal_cortex.c │ ├── stm32f1xx_hal_dma.c │ ├── ... ├── Makefile ├── STM32F103C8Tx_FLASH.ld ├── include │ └── README ├── lib │ └── README ├── one.ioc ├── platformio.ini ├── src ├── startup_stm32f103xb.s └── test └── README 3.配置工程 修改 platformio.ini 在 platformIo.ini中添加：">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2024-10-22T13:28:26+08:00">
    <meta property="article:modified_time" content="2024-10-22T13:28:26+08:00">


    


    

    
    <link rel="canonical" href="https://blog.ronan.us.kg/posts/platformio%E5%9F%BA%E4%BA%8E-stm32-hal%E5%BA%93-%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF/">
    

    

    



    
    <link id="theme-css" rel="stylesheet" href="https://blog.ronan.us.kg/theme.min.8125c5e195258aa61b74485a7c4accfba7efc242481cb11437cb6d93789d00e7.css" integrity="sha256-gSXF4ZUliqYbdEhafErM&#43;6fvwkJIHLEUN8ttk3idAOc=" media="screen" crossorigin="anonymous">



    



    

    
</head>

<body class="bilberry-hugo-theme">
    

    
    <nav>

    <div class="container">
        <ul class="topnav">
            
        </ul>

        
            <div id="search-box" class="search">
                <i class="fas fa-search"></i>
                <input id="search" type="text" placeholder="Search ...">
            </div>
        
    </div>
</nav>


    
    <header>

    <a id="back-to-top-button">
        <i class="fas fa-angle-up"></i>
    </a>

    <div class="container">
        <div class="logo">
            <a href="/" class="logo">
                
                    <img src="https://imgs.ronan.us.kg/avatar.jpg" alt="">
                

                <span class="overlay"><i class="fa fa-home"></i></span>
            </a>
        </div>
        <div class="titles">
            <h3 class="title">
                <a href="/">
                    Ronan Blog
                </a>
            </h3>

            
                <span class="subtitle">「向前每多走一步，热爱和勇气就会多一分。」</span>
            
        </div>
        <div class="selectors">
          
          
       </div>

        
            <div class="toggler">
        
                <i class="fa fa-bars" aria-hidden="true"></i>
            </div>
    </div>
    </div>
</header>


    <div class="main container">
        
    <div class="article-wrapper u-cf single">
        
            <a class="bubble" href="https://blog.ronan.us.kg/posts/platformio%E5%9F%BA%E4%BA%8E-stm32-hal%E5%BA%93-%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF/">
    <i class="fas fa-fw fa-pencil-alt"></i>
</a>

<article class="default article">
    

    <div class="content">
    <h1 class="article-title">
        <a href="https://blog.ronan.us.kg/posts/platformio%E5%9F%BA%E4%BA%8E-stm32-hal%E5%BA%93-%E7%9A%84%E5%B7%A5%E7%A8%8B%E6%A8%A1%E6%9D%BF/">
            「platformIO」基于 stm32 HAL库 的工程模板
        </a>
    </h1>

    <div class="meta">
        
            
                <span class="date moment">2024-10-22</span>
            
        

        

        
            <span class="categories">
                
                    
                    
                        <a href="https://blog.ronan.us.kg/categories/docs/">Docs</a>
                    
                
            </span>
        

        
            <span class="author">
                
                
                    <a href="https://blog.ronan.us.kg/author/ronan/">Ronan</a>
                
            </span>
        
    </div>

    
        

        <h1 id="1建立-makefile-工程">1.建立 Makefile 工程</h1>
<p>通过 STM32CubeMX 建立适于自己开发版的 Makefile 工程（步骤不赘述，百度一下，你就知道），并且记住「<strong>工程名</strong>」和「<strong>工程存放路径</strong>」。</p>
<h1 id="2新建-platformio-工程">2.新建 platformIO 工程</h1>
<p>新建 platformIO 工程时的「Framework」<strong>一定要选择「STM32Cube」</strong>，新建工程的「<strong>工程名</strong>」和「<strong>工程存放路径</strong>」要与之前建立的 Makefile 工程<strong>一致</strong>。</p>
<p>工程建立完成后，你应该会得到如下项目结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>├── Core
</span></span><span style="display:flex;"><span>│   ├── Inc
</span></span><span style="display:flex;"><span>│   │   ├── gpio.h
</span></span><span style="display:flex;"><span>│   │   ├── main.h
</span></span><span style="display:flex;"><span>│   │   ├── ...
</span></span><span style="display:flex;"><span>│   └── Src
</span></span><span style="display:flex;"><span>│       ├── gpio.c
</span></span><span style="display:flex;"><span>│       ├── main.c
</span></span><span style="display:flex;"><span>│       ├── ...
</span></span><span style="display:flex;"><span>├── Drivers
</span></span><span style="display:flex;"><span>│   ├── CMSIS
</span></span><span style="display:flex;"><span>│   │   ├── Device
</span></span><span style="display:flex;"><span>│   │   │   └── ST
</span></span><span style="display:flex;"><span>│   │   │       └── STM32F1xx
</span></span><span style="display:flex;"><span>│   │   │           ├── Include
</span></span><span style="display:flex;"><span>│   │   │           │   ├── stm32f103xb.h
</span></span><span style="display:flex;"><span>│   │   │           │   ├── stm32f1xx.h
</span></span><span style="display:flex;"><span>│   │   │           │   └── system_stm32f1xx.h
</span></span><span style="display:flex;"><span>│   │   │           ├── LICENSE.txt
</span></span><span style="display:flex;"><span>│   │   │           └── Source
</span></span><span style="display:flex;"><span>│   │   │               └── Templates
</span></span><span style="display:flex;"><span>│   │   ├── Include
</span></span><span style="display:flex;"><span>│   │   │   ├── cmsis_armcc.h
</span></span><span style="display:flex;"><span>│   │   │   ├── cmsis_armclang.h
</span></span><span style="display:flex;"><span>│   │   │   ├── cmsis_compiler.h
</span></span><span style="display:flex;"><span>│   │   │   ├── cmsis_gcc.h
</span></span><span style="display:flex;"><span>│   │   │   ├── ...
</span></span><span style="display:flex;"><span>│   │   └── LICENSE.txt
</span></span><span style="display:flex;"><span>│   └── STM32F1xx_HAL_Driver
</span></span><span style="display:flex;"><span>│       ├── Inc
</span></span><span style="display:flex;"><span>│       │   ├── Legacy
</span></span><span style="display:flex;"><span>│       │   │   └── stm32_hal_legacy.h
</span></span><span style="display:flex;"><span>│       │   ├── stm32f1xx_hal.h
</span></span><span style="display:flex;"><span>│       │   ├── stm32f1xx_hal_cortex.h
</span></span><span style="display:flex;"><span>│       │   ├── stm32f1xx_hal_def.h
</span></span><span style="display:flex;"><span>│       │   ├── ...
</span></span><span style="display:flex;"><span>│       ├── LICENSE.txt
</span></span><span style="display:flex;"><span>│       └── Src
</span></span><span style="display:flex;"><span>│           ├── stm32f1xx_hal.c
</span></span><span style="display:flex;"><span>│           ├── stm32f1xx_hal_cortex.c
</span></span><span style="display:flex;"><span>│           ├── stm32f1xx_hal_dma.c
</span></span><span style="display:flex;"><span>│           ├── ...
</span></span><span style="display:flex;"><span>├── Makefile
</span></span><span style="display:flex;"><span>├── STM32F103C8Tx_FLASH.ld
</span></span><span style="display:flex;"><span>├── include
</span></span><span style="display:flex;"><span>│   └── README
</span></span><span style="display:flex;"><span>├── lib
</span></span><span style="display:flex;"><span>│   └── README
</span></span><span style="display:flex;"><span>├── one.ioc
</span></span><span style="display:flex;"><span>├── platformio.ini
</span></span><span style="display:flex;"><span>├── src
</span></span><span style="display:flex;"><span>├── startup_stm32f103xb.s
</span></span><span style="display:flex;"><span>└── test
</span></span><span style="display:flex;"><span>    └── README
</span></span></code></pre></div><h1 id="3配置工程">3.配置工程</h1>
<ul>
<li>修改 platformio.ini</li>
</ul>
<p>在 <strong>platformIo.ini</strong>中添加：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>;烧录方式，有 jlink、stlink 以及 serial 等方式，根据自身情况选择
</span></span><span style="display:flex;"><span>upload_protocol <span style="color:#f92672">=</span> stlink
</span></span><span style="display:flex;"><span>;调试工具选择
</span></span><span style="display:flex;"><span>debug_tool <span style="color:#f92672">=</span> stlink
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>platformio<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>src_dir <span style="color:#f92672">=</span> Core/Src
</span></span><span style="display:flex;"><span>include_dir <span style="color:#f92672">=</span> Core/Inc
</span></span></code></pre></div><ul>
<li>精简结构</li>
</ul>
<p>删除工程根目录下的「src」和「include」文件夹</p>
<p>好了！现在点击 <strong>build</strong> ，没有报错，可以完美运行了！！！</p>
<h1 id="4添加自己的库">4.添加自己的库</h1>
<p>在 platformIO 建立的工程中，根目录下有一个 lib 文件夹，这里就可以存放自己的库。</p>
<p>示例：假设现在有一个 led.c 和 led.h，那么你就可以<strong>在 lib 目录中新建一个 led 目录</strong>，然后将 led.c 和 led.h 放到 ./lib/led 中，之后，在 ./Core/Src/main.c 中直接导入 led.h</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;led.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span> (<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="5遭遇问题">5.遭遇问题</h1>
<blockquote>
<p>以 stmf103c8t6为例</p>
</blockquote>
<ul>
<li>在第一次使用 stlink-v2 烧录时遇到以下问题：</li>
</ul>
<pre tabindex="0"><code>stlink-xPack Open On-Chip Debugger 0.12.0-01004-g9ea7f3d64-dirty (2023-01-30-17:03)
Licensed under GNU GPL v2
For bug reports, read
        http://openocd.org/doc/doxygen/bugs.html
debug_level: 1

hla_swd
Warn : UNEXPECTED idcode: 0x2ba01477
Error: expected 1 of 1: 0x1ba01477
in procedure &#39;program&#39;
** OpenOCD init failed **
shutdown command invoked
</code></pre><ul>
<li>
<p>分析原因<br>
这是因为 stm32f1x.cfg 文件期望的 stm32f1x 芯片 ID 应该是 0x1ba01477 ，但是实际扫描到的设备 id 是 0x2ba01477。</p>
</li>
<li>
<p>问题解决<br>
platformIO 使用的 openocd 是其自行打包下载而不是用户自行下载的第三方包，所以，首先要找到 <code>/Users/&lt;your_username&gt;/.platformio/packages/tool-openocd/openocd/scripts/target/stm32f1x.cfg</code> 并打开，在其中找到以下</p>
</li>
</ul>
<pre tabindex="0"><code>#jtag scan chain
if { [info exists CPUTAPID] } {
   set _CPUTAPID $CPUTAPID
} else {
   if { [using_jtag] } {
      # See STM Document RM0008 Section 26.6.3
      set _CPUTAPID 0x3ba00477
   } {
      # this is the SW-DP tap id not the jtag tap id
      set _CPUTAPID 0x1ba01477
   }
}
</code></pre><p>我们可以看到罪魁祸首就在这里：</p>
<pre tabindex="0"><code># this is the SW-DP tap id not the jtag tap id
set _CPUTAPID 0x1ba01477
</code></pre><p>最后，我们只需要把 <strong>set _CPUTAPID</strong> 后面的 <strong>0x1ba01477</strong> 修改为报错信息里的 <strong>0x2ba01477</strong> ， clean -&gt; build -&gt; upload 一气呵成，再也没有标红的让人狂飙血压的玩意了！</p>

    
</div>

    
<div class="footer no-tags">


    

    
</div>

</article>

        
    </div>

    
        <div id="comments-container">
            
            

            

            

        </div>
    

    </div>

    
<footer>
    <div class="container">

        
        <div class="recent-posts">
            <strong>Latest posts</strong>
            <ul>
                
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/pyinstaller%E5%B0%86python%E5%BA%94%E7%94%A8%E6%89%93%E5%8C%85%E4%B8%BAandroid%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F/">PyInstaller将Python应用打包为Android应用程序</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/gmeek%E4%B8%8A%E4%BC%A0%E8%84%9A%E6%9C%AC%E5%8D%95%E7%AF%87%E6%88%96%E6%89%B9%E9%87%8F/">「Gmeek」上传脚本(单篇或批量)</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/platformioprintf-%E9%87%8D%E6%98%A0%E5%83%8F%E4%B8%B2%E5%8F%A3%E6%89%93%E5%8D%B0%E6%95%B0%E6%8D%AE/">「platformIO」printf 重映像、串口打印数据</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/python%E6%A8%A1%E5%9D%97%E5%92%8C%E5%8C%85/">「Python」模块和包</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/pythonconda%E8%99%9A%E6%8B%9F%E7%8E%AF%E5%A2%83/">「python」Conda虚拟环境</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/python%E4%B8%80%E4%B8%AA%E5%BF%AB%E9%80%9F%E7%94%9F%E6%88%90requirements.txt%E7%9A%84%E5%BA%93/">「python」一个快速生成requirements.txt的库</a>
                    </li>
                
                    <li>
                        <a href="https://blog.ronan.us.kg/posts/orbstackmac-%E7%B3%BB%E7%BB%9F%E4%B8%AD%E4%B8%80%E4%B8%AA%E6%9B%B4%E5%BF%AB%E7%9A%84-docker-%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7%E5%8F%AF%E5%AE%8C%E5%85%A8%E6%9B%BF%E4%BB%A3-docker-desktop/">「OrbStack」Mac 系统中一个更快的 Docker 可视化工具，可完全替代 Docker Desktop</a>
                    </li>
                
            </ul>
        </div>
        

        
        <div class="categories">
            
            <a href="https://blog.ronan.us.kg/categories/"><strong>Categories</strong></a>
            

            <ul>
                
                <li>
                
                    <a href="https://blog.ronan.us.kg/categories/docs/">Docs (38)</a>
                
                </li>
                
                <li>
                
                    <a href="https://blog.ronan.us.kg/categories/linux/">Linux (11)</a>
                
                </li>
                
                <li>
                
                    <a href="https://blog.ronan.us.kg/categories/macos/">Macos (5)</a>
                
                </li>
                
                <li>
                
                    <a href="https://blog.ronan.us.kg/categories/tools/">Tools (5)</a>
                
                </li>
                
                <li>
                
                    <a href="https://blog.ronan.us.kg/categories/vscode/">Vscode (4)</a>
                
                </li>
                
            </ul>
        </div>
        

        <div class="right">
            
            <div class="external-profiles">
                <strong>Social media</strong>
                
                <a href="https://weibo.com/u/5995159469" target="_blank" rel="me"><em class="fab fa-weibo"></em></a>
                
                <a href="https://github.com/EchoZap" target="_blank" rel=""><em class="fab fa-github"></em></a>
                
            </div>
            

            

            
            <div class="archive">
                
                <a href="https://blog.ronan.us.kg/archive/"><strong>Archive</strong></a>
                
            </div>
            
        </div>
    </div>
</footer>


<div class="credits">
    <div class="container">
        <div class="copyright">
            <a href="https://github.com/echozap" target="_blank">
                &copy;
                
                2024
                
                by Ronan
            </a>
            
        </div>
        <div class="author">
            <a href="https://github.com/Lednerb/bilberry-hugo-theme"
                target="_blank">Bilberry Hugo Theme</a>
        </div>
    </div>
</div>


    

    

    


    

    

    

    

    

    

    

    



    
    
    



    
    







    
    <script src="https://blog.ronan.us.kg/theme.min.15a051027515397e36946f37800e8a370e44f72ac97de37ae55b55087e3b0b59.js" integrity="sha256-FaBRAnUVOX42lG83gA6KNw5E9yrJfeN65VtVCH47C1k=" crossorigin="anonymous"></script>



    



    
        <div id="activate-algolia-search" class="hidden">
  <input type="hidden" id="algolia-search-appId" value="GT5UPRMBE6">
  <input type="hidden" id="algolia-search-apiKey" value="9499608ea45258a283445ca59ad50c14">
  <input type="hidden" id="algolia-search-indexName" value="hugo">
  <input type="hidden" id="algolia-search-noSearchResults" value="Nothing found.">

  
  <input type="hidden" id="algolia-search-currentLanguageOnly">
  
</div>

    

    
</body>

</html>
